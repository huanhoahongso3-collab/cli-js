name: Build Banana CLI

on:
  push:
    paths:
      - 'banana/**'
      - '.github/workflows/build-banana.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [16]

    steps:
      - name: 📦 Checkout Repository
        uses: actions/checkout@v3

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}

      - name: 📥 Install pkg
        run: npm install -g pkg

      - name: 📦 Install banana dependencies
        working-directory: banana
        run: npm install

      - name: 🛠️ Build executable with pkg
        working-directory: banana
        run: |
          OS_NAME="${{ runner.os == 'Linux' && 'linux' || runner.os == 'Windows' && 'win' || 'macos' }}"
          OUTPUT_NAME="banana-${OS_NAME}"
          pkg . --targets node${{ matrix.node }}-${OS_NAME}-x64 --output $OUTPUT_NAME

      - name: 📤 Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: banana-${{ runner.os }}-${{ github.run_id }}
          path: banana/banana-*
          if-no-files-found: error
          overwrite: true
